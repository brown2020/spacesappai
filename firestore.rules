rules_version = '2';

// ============================================================================
// FIRESTORE SECURITY RULES FOR SPACES APP
// ============================================================================
//
// Data Model:
//   documents/{documentId}          - Document metadata (title, timestamps)
//   users/{uid}/rooms/{docId} - User's access to documents (role-based)
//
// Roles:
//   owner  - Can read, write, delete document; manage users
//   editor - Can read and write document content
//   viewer - Can read document content only
//
// Copy this entire file to Firebase Console > Firestore > Rules
// ============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get the user's uid from auth token
    function getUserId() {
      return request.auth.uid;
    }

    // Check if user has any access to a document (owner or editor)
    function hasRoomAccess(documentId) {
      return exists(/databases/$(database)/documents/users/$(getUserId())/rooms/$(documentId));
    }

    // Get user's role for a document
    function getUserRole(documentId) {
      return get(/databases/$(database)/documents/users/$(getUserId())/rooms/$(documentId)).data.role;
    }

    // Check if user is the owner of a document
    function isOwner(documentId) {
      return hasRoomAccess(documentId) && getUserRole(documentId) == 'owner';
    }

    // Check if user is an editor of a document
    function isEditor(documentId) {
      return hasRoomAccess(documentId) && getUserRole(documentId) == 'editor';
    }

    // Check if user can read a document (any role).
    function canReadDocument(documentId) {
      return hasRoomAccess(documentId);
    }

    // Check if user can write a document (owner or editor, not viewer).
    function canWriteDocument(documentId) {
      return hasRoomAccess(documentId)
        && (getUserRole(documentId) == 'owner' || getUserRole(documentId) == 'editor');
    }

    // Validate document data on create/update
    function isValidDocumentData() {
      let data = request.resource.data;
      return data.keys().hasAll(['title'])
        && data.title is string
        && data.title.size() > 0
        && data.title.size() <= 500
        // icon is optional, but if present must be null or a string <= 10 chars (emoji)
        && (!('icon' in data.keys()) || data.icon == null || (data.icon is string && data.icon.size() <= 10))
        // isPublished is optional, but if present must be a boolean
        && (!('isPublished' in data.keys()) || data.isPublished is bool);
    }

    // Validate room data
    function isValidRoomData() {
      let data = request.resource.data;
      return data.keys().hasAll(['userId', 'role', 'roomId', 'createdAt'])
        && data.userId is string
        && data.role in ['owner', 'editor', 'viewer']
        && data.roomId is string;
    }

    // ========================================================================
    // DOCUMENTS COLLECTION
    // ========================================================================

    match /documents/{documentId} {
      // Allow read if user has any room access (owner, editor, or viewer)
      allow read: if isAuthenticated() && canReadDocument(documentId);

      // Allow create if authenticated with valid data
      // Note: Document creation is primarily handled by server actions with admin SDK,
      // but we validate client-side creates as a defense-in-depth measure.
      allow create: if isAuthenticated() && isValidDocumentData();

      // Allow update if user can write (owner or editor, not viewer)
      allow update: if isAuthenticated()
        && canWriteDocument(documentId)
        && isValidDocumentData();

      // Allow delete only if user is the owner
      allow delete: if isAuthenticated() && isOwner(documentId);
    }

    // ========================================================================
    // USERS COLLECTION (Room Access)
    // ========================================================================

    match /users/{uid} {
      // Users can read their own user document
      allow read: if isAuthenticated() && getUserId() == uid;

      // Room subcollection - tracks which documents a user has access to
      match /rooms/{roomId} {
        // Users can read their own room entries
        allow read: if isAuthenticated() && getUserId() == uid;

        // Allow create if:
        // 1. User is creating their own entry as owner (new document), OR
        // 2. Existing owner is inviting this user as editor
        allow create: if isAuthenticated()
          && isValidRoomData()
          && (
            // Creating own entry as owner
            (getUserId() == uid
              && request.resource.data.userId == uid
              && request.resource.data.role == 'owner')
            // OR being invited by the document owner as editor or viewer
            || (isOwner(roomId)
              && request.resource.data.userId == uid
              && request.resource.data.role in ['editor', 'viewer'])
          );

        // Only owners can update room entries (e.g., change roles)
        allow update: if isAuthenticated()
          && isOwner(roomId)
          && isValidRoomData();

        // Allow delete if:
        // 1. Owner is removing someone else, OR
        // 2. User is removing themselves (leaving document)
        allow delete: if isAuthenticated()
          && (
            isOwner(roomId)
            || getUserId() == uid
          );
      }
    }

    // ========================================================================
    // COLLECTION GROUP QUERIES
    // ========================================================================

    // Allow collection group queries on 'rooms' for finding all users in a room
    // This is used by useRoomUsers hook
    match /{path=**}/rooms/{roomId} {
      allow read: if isAuthenticated() && hasRoomAccess(roomId);
    }
  }
}
